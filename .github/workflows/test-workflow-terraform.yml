name: Test workflow terraform
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.2.5
      - uses: actions/checkout@master
      - name: Run terraform init (to load the providers which are used by the terraform show command)
        run: |
          cd ./tests/inputs/terraform
          terraform init -backend=false
        shell: bash
      - name: Run terraform show and save it as json file
        run: |
          cd ./tests/inputs/terraform
          echo *
          jsonPlan=$(terraform show -json plan.tfplan)
          # Manipulation of the JSON output from the show commmand above, to remove the [command]...plan.json line at the beginning of the file.
          # Check if the file starts with [command]
          if  [[ $jsonPlan == [command]* ]] ;
          then
            echo "The file starts with [command]"
          fi 
          
          echo "$jsonPlan" > $GITHUB_WORKSPACE/tests/inputs/terraform/plan.json

          echo *
#      - name: Archive plan.json as a downloadable artifact
#        uses: actions/upload-artifact@v3
#        with:
#          name: Terraform plan json
#          path: tests/inputs/terraform/plan.json
#      - name: Run the action
#        uses: ./
#        with:
#          IACType: terraform
#          IACFile: $GITHUB_WORKSPACE/tests/inputs/terraform/plan.json
#          CloudProvider: azure
#          CARBON_RATE_PROVIDER: electricitymap